$90DayBody =  @'
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<body>
    <style>
        .learn-more {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: white;
            padding: 7px 7px 7px 7px;
            background-color: #008510;
            border: 1px solid black;
            text-decoration: none;
        }

        .resource {
            border-bottom: 0px none #ffffff;
            border-top: 1px solid #555555;
            border-left: 0px none #ffffff;
            border-right: 0px none #ffffff;
            padding-bottom: 20px;
        }

        p {
            padding: 0px 20px 0px 20px;
            font-family: Arial,'Arial Narrow', sans-serif;
        }

        h3 {
            font-family: Arial, sans-serif;
            font-weight: normal;
            font-size: 1.25em;
            color: #0072c6;
            text-decoration: none;
        }

        .learn-more a {
            color: white;
            text-decoration: none;
        }

        .learn-more a:hover {
            color: white;
            text-decoration: underline;
        }
    </style>
    <table style="width:800px;border-bottom:2px solid gray;border-top:2px solid gray;border-left:2px solid gray;border-right:2px solid gray;padding: 10px;">
        <tr>
            <td>
                <table style="width:770px;background:#0072c6;color:white;text-align:center">
                    <tr>
                        <td>
                            <h1>Once More Unto The Breach</h1>
                        </td>
                    </tr>
                </table>
                <p>Greetings {0},</p>
                <p>Learning never stops. Dive a little deeper into Office with these tutorials.</p>
                <div class="resource">
                    <h3>Advanced tables of contents</h3>
                    <p>In this course, we'll use some advanced techniques to create a custom TOC, in which you have complete control over the contents in Word.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-10e89d4e-ec5a-4f31-b4d6-a61077427951">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Collapsible headings</h3>
                    <p>Collapsible headings can make it easier to read and quickly organize a document in Word. When readers open the document, they can use the collapsed headings like a table of contents - choose the section they want to read and click the triangle next to it to expand it.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-c7b03e92-a397-479d-b989-57393daf2d65">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Insert headers and footers</h3>
                    <p>You can add headers to the top and footers to the bottom of a worksheet. When you print the worksheet, the headers and footers also print. For example, you might create a header with the file path and a footer with page numbers. Headers and footers display only in Page Layout view and on printed pages. Take this quick course to learn more.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-3b4da988-f8f7-49be-bae0-ddb95c9ade15">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Take conditional formatting to the next level</h3>
                    <p>In the course Use conditional formatting, we covered the basics of conditional formatting for Excel. Here, we'll go a few steps further and see how to apply conditional formatting to cells, tables, PivotTables, and worksheets. For example, to quickly conditionally format cells, you can use a Quick Analysis option or an option on the Conditional Formatting button in the ribbon. We'll also use formulas to apply conditional formatting, and learn how to edit and delete rules using the Conditional Formatting Rules Manager.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-542c19e3-3f1d-443b-b48e-3360102a0315">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: Ways to avoid rebuilding PowerPoints over and over</h3>
                    <p>You've got a meeting coming up where several team members will be presenting. So how do you jumble and juggle multiple PowerPoint presentations without reinventing wheels, losing pieces or looking unprofessional? We'll look at a few ways to make a new presentation out of slides you already have, and see how you can take the same slide deck to several meetings and give customized, unique presentations at each one.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/ways123">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: Using video in PowerPoint</h3>
                    <p>We show you how to embed and play videos in your PowerPoint presentations and in the free PowerPoint Online.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/powerpointvideo">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: Archiving items in Outlook</h3>
                    <p>You can think of archiving as a way to clean up your Inbox (especially if you're running into limits) or as a backup. We'll show you what you need to know about AutoArchiving and Online Archiving in Outlook.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/arch123">Watch Online</a></td></tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>
'@

$90DaySubject = "More Office Tips"

$30DayBody =  @'
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<body>
    <style>
        .learn-more {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: white;
            padding: 7px 7px 7px 7px;
            background-color: #008510;
            border: 1px solid black;
            text-decoration: none;
        }

        .resource {
            border-bottom: 0px none #ffffff;
            border-top: 1px solid #555555;
            border-left: 0px none #ffffff;
            border-right: 0px none #ffffff;
            padding-bottom: 20px;
        }

        p {
            padding: 0px 20px 0px 20px;
            font-family: Arial,'Arial Narrow', sans-serif;
        }

        h3 {
            font-family: Arial, sans-serif;
            font-weight: normal;
            font-size: 1.25em;
            color: #0072c6;
            text-decoration: none;
        }

        .learn-more a {
            color: white;
            text-decoration: none;
        }

        .learn-more a:hover {
            color: white;
            text-decoration: underline;
        }
    </style>
    </style>
    <table style="width:800px;border-bottom:2px solid gray;border-top:2px solid gray;border-left:2px solid gray;border-right:2px solid gray;padding: 10px;">
        <tr>
            <td>
                <table style="width:770px;background:#0072c6;color:white;text-align:center">
                    <tr>
                        <td>
                            <h1>The Power of Office</h1>
                        </td>
                    </tr>
                </table>
                <p>Greetings {0},</p>
                <p>With Office, you are more powerful than you think. Let these tutorials show you how to unlock that potential.</p>
                <div class="resource">
                    <h3>Using Styles in Word</h3>
                    <p>Watch these tutorial videos to learn how format your document using Quick Styles in Word 2013. We will also show you the benefits for using Quick Styles, like organizing a large document fast.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-9db4c0f4-2754-4294-9758-c14a0abd8cfa">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: Creating Forms in Word</h3>
                    <p>Need a form fast? We'll show you how to grab a professional made template in Word, personalize it, even lock it down so folks can't monkey with the various fields.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/forms123">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Insert headers and footers</h3>
                    <p>You can add headers to the top and footers to the bottom of a worksheet. When you print the worksheet, the headers and footers also print. For example, you might create a header with the file path and a footer with page numbers. Headers and footers display only in Page Layout view and on printed pages. Take this quick course to learn more.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-3b4da988-f8f7-49be-bae0-ddb95c9ade15">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Use conditional formatting</h3>
                    <p>It can be hard to get a lot of meaning out of numbers in a worksheet. But Excel provides a bunch of ways to quickly analyze your data using conditional formatting. For example, you can use a color scale to differentiate high, medium, and low temperature values.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-03ab07da-1564-4913-b69f-2b1a370c8910">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: 5 steps to a better PowerPoint</h3>
                    <p>Do you know the best way to begin with PowerPoint? Do you think about where to sit in a meeting room? We'll show these are other simple steps to make your next presentation do more with less sweat in this webinar.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/better123">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Webinar: 8 great timesavers in Outlook</h3>
                    <p>Did you know that you can drag any email into your calendar to make an appointment? Or you can just ignore pesky emails? You will if you watch this Office 15-Minute Webinar.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://aka.ms/outlook8">Watch Online</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Share or publish your Office 365 Business calendar</h3>
                    <p>If you have Office 365 Business, you can share or publish your calendar so others can view your appointments and meetings.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="https://support.office.com/en-us/article/Watch-online-a6ff417f-e055-4a05-b2b6-52632e96e04b">Watch Online</a></td></tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>
'@

$30DaySubject = "A Month of Office"

$5DayBody =  @'
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<body>
    <style>
        .learn-more {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: white;
            padding: 7px 7px 7px 7px;
            background-color: #008510;
            border: 1px solid black;
            text-decoration: none;
        }

        .resource {
            border-bottom: 0px none #ffffff;
            border-top: 1px solid #555555;
            border-left: 0px none #ffffff;
            border-right: 0px none #ffffff;
            padding-bottom: 20px;
        }

        p {
            padding: 0px 20px 0px 20px;
            font-family: Arial,'Arial Narrow', sans-serif;
        }

        h3 {
            font-family: Arial, sans-serif;
            font-weight: normal;
            font-size: 1.25em;
            color: #0072c6;
            text-decoration: none;
        }

        .learn-more a {
            color: white;
            text-decoration: none;
        }

        .learn-more a:hover {
            color: white;
            text-decoration: underline;
        }
    </style>
    <table style="width:800px;border-bottom:2px solid gray;border-top:2px solid gray;border-left:2px solid gray;border-right:2px solid gray;padding: 10px;">
        <tr>
            <td>
                <table style="width:770px;background:#0072c6;color:white;text-align:center">
                    <tr>
                        <td>
                            <h1>Work Smarter With Office</h1>
                        </td>
                    </tr>
                </table>
                <p>Greetings {0},</p>
                <p>Hopefully, you're starting to get a handle on your new Office tools. Here are some more tips on how to get the most out of Office.</p>
                <div class="resource">
                    <h3>Zoom in with PowerPoint</h3>
                    <p>Direct your audience's attention right to your point in your PowerPoint presentation. Zoom in on a diagram, chart, or graphic with a couple of clicks, and zoom out just as smoothly.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=511362">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Keep your notes close at hand</h3>
                    <p>Stay organized and collaborate with teammates using OneNote in Office 365 on all your devices. Your notes are saved automatically as you make them*—just like a paper notebook. They go with you everywhere too and, unlike paper notebooks, you don't have to worry about losing them.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532443">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Draw, sketch, or handwrite notes</h3>
                    <p>Use your finger, stylus, or mouse on any Touch-capable device—and automatically convert your handwriting to text.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=511391">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Record your notes</h3>
                    <p>Don't miss important information when you video and audio record your notes during important meetings.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=511392">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Let Excel work for you</h3>
                    <p>Save time as Excel learns your pattern and auto-completes remaining data. No formulas or macros required.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532458">Learn more</a></td></tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>
'@

$5DaySubject = "First Week of Office"

$1DayBody = @'
<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<body>
    <style>
        .learn-more {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: white;
            padding: 7px 7px 7px 7px;
            background-color: #008510;
            border: 1px solid black;
            text-decoration: none;
        }

        .resource {
            border-bottom: 0px none #ffffff;
            border-top: 1px solid #555555;
            border-left: 0px none #ffffff;
            border-right: 0px none #ffffff;
            padding-bottom: 20px;
        }

        p {
            padding: 0px 20px 0px 20px;
            font-family: Arial,'Arial Narrow', sans-serif;
        }

        h3 {
            font-family: Arial, sans-serif;
            font-weight: normal;
            font-size: 1.25em;
            color: #0072c6;
            text-decoration: none;
        }

        .learn-more a {
            color: white;
            text-decoration: none;
        }
        .learn-more a:hover {
            color: white;
            text-decoration: underline;
        }
    </style>
    <table style="width:800px;border-bottom:2px solid gray;border-top:2px solid gray;border-left:2px solid gray;border-right:2px solid gray;padding: 10px;">
        <tr>
            <td>
                <table style="width:770px;background:#0072c6;color:white;text-align:center">
                    <tr>
                        <td>
                            <h1>Getting Started With Office</h1>
                        </td>
                    </tr>
                </table>
                <p>Greetings {0},</p>
                <p>Getting a new set of tools can be confusing especially something as powerful as Office. Check out some of the resources below to help get you rolling.</p>
                <div class="resource">
                    <h3>Simplify sharing</h3>
                    <p>Your files are saved online* so you can send everyone a link to the file where updates can be made together, at the same time.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532454">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>A PDF time-saver you'll love</h3>
                    <p>Open a PDF in Word on your desktop, and you can edit content as if you created it in Word.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=511372">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Work together from anywhere</h3>
                    <p>Share your OneNote notebooks with others so that everyone can edit and share notes in the same place. Your notes are synced to OneDrive for Business, giving everyone access to them from wherever they are.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532462">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Analyze your data instantly</h3>
                    <p>Discover and compare different ways to represent your data visually then apply formatting, sparklines, charts, and tables with a single click.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532455">Learn more</a></td></tr>
                    </table>
                </div>
                <div class="resource">
                    <h3>Get a better picture of your data</h3>
                    <p>Let Excel recommended the charts that best illustrate your data's patterns. Quickly preview your chart and graph options, then pick the ones that present your insights most clearly.</p>
                    <table>
                        <tr><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td class="learn-more"><a href="http://go.microsoft.com/fwlink/p/?LinkId=532457">Learn more</a></td></tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</body>

</html>
'@

$1DaySubject = "First Day of Office"

Function Update-UserLicenseData {

<#
.SYNOPSIS
Finds all the MSOLUsers that are licensed with the specified plan and stores them in a csv

.DESCRIPTION
Finds all the MSOLUsers that are licensed with the specified plan and stores them in a csv.
It populates an extra field in the csv the specifies the earliest point at which the csv
knew the user was licensed (LicensedAsOf field). If a user doesn't show up in the licensed list at a later date
the function takes note and populates another field in the csv with that date (DelicensedAsOf)

.PARAMETER ServiceName
The Name of the Service Plan that you wish to track licensed users for

.PARAMETER CSVPath
The Full file path of the CSV you wish the data to be tracked in

.PARAMETER Credentials
Credentials for connecting to MSOL service

.PARAMETER Username
Used to generate Credentials for connecting to MSOL service

.PARAMETER Password
Used to generate Credentials for connecting to MSOL service

.Example
Update-UserLicenseData
Get list of Users that are licensed for OFFICESUBSCRIPTION service plan and store the results in an AppData Folder
The user will be prompted for their credentials.

.Example
Update-UserLicenseData -ServiceName "OFFICESUBSCRIPTION"
Get list of Users that are licensed for OFFICESUBSCRIPTION service plan and store the results in public documents.
The user will be prompted for their credentials.

.Example
Update-UserLicenseData -ServiceName "OFFICESUBSCRIPTION" -CSVPath "$env:Public\Documents\LicensedUsers.csv" -Credentials $creds
Get list of Users that are licensed for OFFICESUBSCRIPTION service plan and store the results in public documents.
The user won't be prompted for their credentials

.Notes
Proper use of this script should involve running this as a scheduled task using a service account (not personal)
because the password will be put in plan text in the scheduled task.

    1.  On the system that the task will be run from, open the Windows Task Scheduler. 
        This can be found in the Start menu, under Start > Administrative Tools.
        (For Windows 7 and upward, you can just search for Task Scheduler in the start
        menu)

    2.  In the Task Scheduler, select the Create Task option under the Actions heading 
        on the right-hand side.

    3.  Enter a name for the task, and give it a description (the description is optional 
        and not required).

    4.  In the General tab, go to the Security options heading and specify the user account 
        that the task should be run under. Change the settings so the task will run if the 
        user is logged in or not.

    5.  Next, select the Triggers tab, and click New to add a new trigger for the scheduled 
        task. This new task should use the On a schedule option. The start date can be set 
        to a desired time, and the frequency and duration of the task can be set based on 
        your specific needs. Click OK when your desired settings are entered.

    6.  Next, go to the Actions tab and click New to set the action for this task to run. 
        Set the Action to Start a program.

    7.  In the Program/script box enter "PowerShell.exe"
        In the Add arguments (optional) box enter the value:

        . ./Get-NewOfficeUsers.ps1;Update-UserLicenseData -ServiceName [ServiceName] -Username [username] -Password [password])

    8.  Then, in the Start in (optional) box, add the location of the folder that contains 
        your PowerShell script.

        Note: The location used in the Start in box will also be used for storing the scheduled task 
        run times, the job history for the copies, and any additional logging that may occur.
        Click OK when all the desired settings are made.

    9. Next, set any other desired settings in the Conditions and Settings tabs. You can also set up 
        additional actions, such as emailing an Administrator each time the script is run.

    10. Once all the desired actions have been made (or added), click OK. The task will be immediately 
        set, and is ready to run.

        The scheduling of this task is complete, and is now ready to run based on the entered settings.

#>

[CmdletBinding(DefaultParameterSetName="PSCredential")]
Param(

    [Parameter()]
    [string] $ServiceName = "OFFICESUBSCRIPTION",

    [Parameter()]
    [string] $CSVPath = "$env:APPDATA\Microsoft\OfficeAutomation\OfficeLicenseTracking.csv",

    [Parameter(ParameterSetName="PSCredential")]
    [PSCredential] $Credentials,

    [Parameter(ParameterSetName="UsernamePassword")]
    [string] $Username,

    [Parameter(ParameterSetName="UsernamePassword")]
    [string] $Password

)

Process{
    if($PSCmdlet.ParameterSetName -eq "UsernamePassword")
    {
        $PWord = ConvertTo-SecureString –String $Password –AsPlainText -Force
        $Credentials = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList $Username, $PWord
    } else {
      if (!($Credentials)) {
        $Credentials = (Get-Credential)
      }
    }

    if ($Credentials) {
        $Domain = $Credentials.UserName.Split('@')[1]
        $CSVPath = "$env:APPDATA\Microsoft\OfficeAutomation\OfficeLicenseTracking-$Domain.csv"
    
        Write-host
        Write-host "Connecting to Office 365..."
        <# write log#>
        $lineNum = Get-CurrentLineNumber    
        $filName = Get-CurrentFileName 
        WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "Connecting to Office 365..."

        Connect-MsolService -Credential $Credentials

        Write-host "Retrieving User List..."
        <# write log#>
        $lineNum = Get-CurrentLineNumber    
        $filName = Get-CurrentFileName 
        WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "Retrieving User List..."

        $Users = Get-MsolUser | ? IsLicensed -eq $True | Select DisplayName, Licenses, LiveId, ObjectId, SignInName, UserPrincipalName 
    
        #Get list of users with the correct service plan
        $LicensedUsers = new-object PSObject[] 1;
        foreach($User in $Users){
            :LicenseLoop foreach($License in $User.Licenses){
                foreach($ServiceStatus in $License.ServiceStatus){
                    if($ServiceStatus.ServicePlan.ServiceName -eq $ServiceName){
                        $LicensedUsers += $User
                        break LicenseLoop
                    } #End if
                } #End ServiceStatus Foreach
            } #End License Foreach
        } #End User in Users Foreach
        
        #Add tracking properties
        foreach($User in $LicensedUsers){
            if($User -ne $Null){
                Add-Member -InputObject $User -MemberType NoteProperty -Name LicensedAsOf -Value "$(Get-Date -Format "yyyy-MM-dd hh:mm")"
                Add-Member -InputObject $User -MemberType NoteProperty -Name DelicensedAsOf -Value "-"
                Add-Member -InputObject $User -MemberType NoteProperty -Name Day1EmailSent -Value "$false"
                Add-Member -InputObject $User -MemberType NoteProperty -Name Day5EmailSent -Value "$false"
                Add-Member -InputObject $User -MemberType NoteProperty -Name Day30EmailSent -Value "$false"
                Add-Member -InputObject $User -MemberType NoteProperty -Name Day90EmailSent -Value "$false"
            } #End if
        } #End User in LicensedUsers Foreach

        $pathSplit = Split-Path -Path $CSVPath
        $createDir = [system.io.directory]::CreateDirectory($pathSplit)

        #Check if CSV exists
        if(Test-Path $CSVPath){
            #if CSV exists, import it and compare and update values
            $ImportedCSV = Import-Csv $CSVPath
        

            Foreach($ImportedUser in $ImportedCSV){
                $CheckUser = $LicensedUsers | ? ObjectId -eq $ImportedUser.ObjectId
                if($CheckUser -eq $Null){
                    $ImportedUser.DelicensedAsOf = "$(Get-Date -Format "yyyy-MM-dd hh:mm")"
                } #End if
            } #End ImportedUser Foreach

            Foreach($LicensedUser in $LicensedUsers){
                $CheckUser = $ImportedCSV | ? ObjectId -eq $LicensedUser.ObjectId
                if($CheckUser -eq $Null){
                    if($LicensedUser -ne $Null){
                        $ImportedCSV += $LicensedUser
                    } #end LicensedUser if
                } #end CheckUser if
            } #End LicensedUser Foreach
            $ImportedCSV | Export-Csv $CSVPath -NoTypeInformation

            Write-host "CSV File Updated: $CSVPath"
            <# write log#>
            $lineNum = Get-CurrentLineNumber    
            $filName = Get-CurrentFileName 
            WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "CSV File Updated: $CSVPath"
        } #End TestPath if
        else{
            #If csv does not exist, export data
            $LicensedUsers | ? ObjectId -ne $Null | Export-Csv $CSVPath -NoTypeInformation

            Write-host "CSV File Created: $CSVPath"
            <# write log#>
            $lineNum = Get-CurrentLineNumber    
            $filName = Get-CurrentFileName 
            WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "CSV File Created: $CSVPath"
        } #End TestPath Else
    }#end Credentials If
}#End Process

}

Function Get-RecentlyLicensedUsers {

<#
.SYNOPSIS
Get a list of users the were licensed after the specified date according to the specified csv

.DESCRIPTION
Get a list of users the were licensed after the specified date according to the specified csv.
It is important to have run the Update-UserLicenseData.ps1 prior to using this script.

.PARAMETER CutOffDate
The cutoff date for how new you wish the return list of users to be

.PARAMETER CSVPath
The Full file path of the CSV with the data (should be the same as the path used for
Update-UserLicenseData.ps1).

.Example
Get-RecentlyLicensedUsers 
Get list of Users that are were licensed in the last 7 days if the Update-UserLicenseData cmdlet has already been run

.Example
Get-RecentlyLicensedUsers -CutOffDate (Get-Date "2015-7-13) -CSVPath "$env:Public\Documents\LicensedUsers.csv"
Get list of Users that are were licensed after July 7, 2015 according to specified csv

#>

[CmdletBinding()]
Param(

    [Parameter()]
    [string] $CSVPath,

    [Parameter()]
    [DateTime] $CutOffDate

)

Begin {
    $defaultDisplaySet = 'DisplayName', 'SignInName'

    $defaultDisplayPropertySet = New-Object System.Management.Automation.PSPropertySet(‘DefaultDisplayPropertySet’,[string[]]$defaultDisplaySet)
    $PSStandardMembers = [System.Management.Automation.PSMemberInfo[]]@($defaultDisplayPropertySet)
}#End Begin

Process{
    
    if (!($CutOffDate)) {
       $CutOffDate = (Get-Date).AddDays(-7)
    }#end !CutOffDate

    [System.IO.FileSystemInfo[]]$filePaths = @()

    if (!($CSVPath)) {
        $childItems = Get-ChildItem -Path "$env:APPDATA\Microsoft\OfficeAutomation" | where {$_.Extension.ToLower() -eq ".csv" }
        foreach ($csvFile in $childItems) {
           $filePaths += $csvFile
        }#end foreach csvFile
    } else {
       $filePaths += ([System.IO.FileInfo]"$CSVPath")
    }#end if/else !csvPath
    
    if ($filePaths.Length -eq 0) {
      Write-Host "No CSV File Exits. Please run Update-UserLicenseData to generate the CSV File."
      <# write log#>
        $lineNum = Get-CurrentLineNumber    
        $filName = Get-CurrentFileName 
        WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "No CSV File Exits. Please run Update-UserLicenseData to generate the CSV File."
    } #End if filePaths

    foreach ($csvFile in $filePaths) {
        $fileName = $csvFile.Name.Replace($csvFile.Extension, "")
        $domain = ""
        if ($fileName.Contains("-")) {
           $domain = $fileName.Split('-')[1]
        }#End if fileName
       
        if (($PSCmdlet.MyInvocation.PipelineLength -eq 1) -or `
            ($PSCmdlet.MyInvocation.PipelineLength -eq $PSCmdlet.MyInvocation.PipelinePosition)) {

            Write-Host ""
            Write-Host "Retrieving New Users Since: $CutOffDate"
            Write-Host ""
            <# write log#>
            $lineNum = Get-CurrentLineNumber    
            $filName = Get-CurrentFileName 
            WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "Retrieving New Users Since: $CutOffDate"
            if ($domain) {
               Write-Host "Domain: $domain"
               <# write log#>
                $lineNum = Get-CurrentLineNumber    
                $filName = Get-CurrentFileName 
                WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "Domain: $domain"
            }#end If domain
        }#End if pipeline

        $NewUsers = new-object PSObject[] 1;

        $ImportedCSV = Import-Csv -LiteralPath $csvFile.FullName

        foreach($User in $ImportedCSV){
            if ($CutOffDate -lt (Get-Date($user.LicensedAsOf))) {
              if ($domain) {
                Add-Member -InputObject $User -MemberType NoteProperty -Name "Domain" -Value $domain
              }#End If domain
              $User | Add-Member MemberSet PSStandardMembers $PSStandardMembers

              $NewUsers += $User
            }#End if CutOffDate
        }#End Foreach User

        return $NewUsers
    }#End foreach csvFile
}#End Process

}

Function Send-RecentUserEmails{
<#
.SYNOPSIS
Sends emails to Users at intervals to encourage use of Office

.DESCRIPTION
Uses the data stored in the csv populated in Update-UserLicenseData.
Sends emails at 1, 5, 30, 90 days to users after the LicensedAsOf date.

.PARAMETER SmtpServer
The SmtpServer of the Email that will be used to send the emails

.PARAMETER CSVPath
The Full file path of the CSV where the data is tracked

.PARAMETER Credentials
Credentials for connecting to MSOL service

.PARAMETER Username
Used to generate Credentials for connecting to MSOL service

.PARAMETER Password
Used to generate Credentials for connecting to MSOL service

.Example
Send-RecentUserEmails
Sends emails to all the users in the proper intervals that have not received the emails yet.
Will look for the csv in the default location using the domain name from the credentials.
The user will be prompted for their credentials.

.Example
Send-RecentUserEmails -Credentials $creds
Sends emails to all the users in the proper intervals that have not received the emails yet.
Will look for the csv in the default location using the domain name from the credentials.
The user won't be prompted for their credentials.

.Example
Send-RecentUserEmails -Credentials $creds -CSVPath "$env:Public\Documents\LicensedUsers.csv"
Sends emails to all the users from the LicensedUsers.csv in Public Documents folder
in the proper intervals that have not received the emails yet.
The user won't be prompted for their credentials.

.Notes
Proper use of this script should involve running this as a scheduled task using a service 
account (not personal) because the password will be put in plan text in the scheduled task.

    1.  On the system that the task will be run from, open the Windows Task Scheduler. 
        This can be found in the Start menu, under Start > Administrative Tools.
        (For Windows 7 and upward, you can just search for Task Scheduler in the start
        menu)

    2.  In the Task Scheduler, select the Create Task option under the Actions heading 
        on the right-hand side.

    3.  Enter a name for the task, and give it a description (the description is optional 
        and not required).

    4.  In the General tab, go to the Security options heading and specify the user account 
        that the task should be run under. Change the settings so the task will run if the 
        user is logged in or not.

    5.  Next, select the Triggers tab, and click New to add a new trigger for the scheduled 
        task. This new task should use the On a schedule option. The start date can be set 
        to a desired time, and the frequency and duration of the task can be set based on 
        your specific needs. Click OK when your desired settings are entered.

    6.  Next, go to the Actions tab and click New to set the action for this task to run. 
        Set the Action to Start a program.

    7.  In the Program/script box enter "PowerShell.exe"
        In the Add arguments (optional) box enter the value:

        . ./Get-NewOfficeUsers.ps1;Send-RecentUserEmails -SmtpServer [SmtpServer] -Username [username] -Password [password])

    8.  Then, in the Start in (optional) box, add the location of the folder that contains 
        your PowerShell script.

        Note: The location used in the Start in box will also be used for storing the scheduled task 
        run times, the job history for the copies, and any additional logging that may occur.
        Click OK when all the desired settings are made.

    9. Next, set any other desired settings in the Conditions and Settings tabs. You can also set up 
        additional actions, such as emailing an Administrator each time the script is run.

    10. Once all the desired actions have been made (or added), click OK. The task will be immediately 
        set, and is ready to run.

        The scheduling of this task is complete, and is now ready to run based on the entered settings.

#>
[CmdletBinding()]
Param(

    [Parameter()]
    [string] $SmtpServer = "smtp.office365.com",

    [Parameter()]
    [string] $CSVPath = "$env:APPDATA\Microsoft\OfficeAutomation\OfficeLicenseTracking.csv",

    [Parameter(ParameterSetName="PSCredential")]
    [PSCredential] $Credentials,

    [Parameter(ParameterSetName="UsernamePassword")]
    [string] $Username,

    [Parameter(ParameterSetName="UsernamePassword")]
    [string] $Password

)

Process{

    if($PSCmdlet.ParameterSetName -eq "UsernamePassword")
    {
        $PWord = ConvertTo-SecureString –String $Password –AsPlainText -Force
        $Credentials = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList $Username, $PWord
    } else {
      if (!($Credentials)) {
        $Credentials = (Get-Credential)
      }
    }

    if($Credentials){

        $Domain = $Credentials.UserName.Split('@')[1]
        $CSVPath = "$env:APPDATA\Microsoft\OfficeAutomation\OfficeLicenseTracking-$Domain.csv"
        $5DaysAgo = (Get-Date).AddDays(-5);
        $30DaysAgo = (Get-Date).AddDays(-30);
        $90DaysAgo = (Get-Date).AddDays(-90);
        if(Test-Path $CSVPath){
            $Users = Import-Csv $CSVPath

            $Denominator = $Users.Count;
            [int]$Progress = 0;
            Write-Progress -Activity "Sending Emails" -Status "Processing Users" -PercentComplete ($Progress/$Denominator)

            foreach( $User in $Users ){
        
                if((Get-Date($User.LicensedAsOf)) -gt $5DaysAgo -and $User.Day1EmailSent -eq $false){

                    $Body = $1DayBody -f $User.DisplayName
                    Send-MailMessage -To $User.UserPrincipalName -From $Credentials.UserName -Subject $1DaySubject -Body $Body -SmtpServer $SmtpServer -Credential $Credentials -UseSsl -Port "587"
                    $User.Day1EmailSent = "$(Get-Date -Format "yyyy-MM-dd hh:mm")" ;

                }elseif((Get-Date($User.LicensedAsOf)) -gt $30DaysAgo -and $User.Day5EmailSent -eq $false){

                    $Body = $5DayBody -f $User.DisplayName
                    Send-MailMessage -To $User.UserPrincipalName -From $Credentials.UserName -Subject $5DaySubject -Body $Body -SmtpServer $SmtpServer -Credential $Credentials -UseSsl -Port "587"
                    $User.Day5EmailSent = "$(Get-Date -Format "yyyy-MM-dd hh:mm")";

                }elseif((Get-Date($User.LicensedAsOf)) -gt $90DaysAgo -and $User.Day30EmailSent -eq $false){

                    $Body = $30DayBody -f $User.DisplayName
                    Send-MailMessage -To $User.UserPrincipalName -From $Credentials.UserName -Subject $30DaySubject -Body $Body -SmtpServer $SmtpServer -Credential $Credentials -UseSsl -Port "587"
                    $User.Day30EmailSent = "$(Get-Date -Format "yyyy-MM-dd hh:mm")";

                }elseif($User.Day90EmailSent -eq $false){

                    $Body = $90DayBody -f $User.DisplayName
                    Send-MailMessage -To $User.UserPrincipalName -From $Credentials.UserName -Subject $90DaySubject -Body $Body -SmtpServer $SmtpServer -Credential $Credentials -UseSsl -Port "587"
                    $User.Day90EmailSent = "$(Get-Date -Format "yyyy-MM-dd hh:mm")";

                }#End Date if/elses

                $Progress += 1
                Write-Progress -Activity "Sending Emails" -Status "Processing Users" -PercentComplete ($Progress/$Denominator)

            }#end Foreach User

            $Users | Export-Csv $CSVPath
        }#end If TestPath
        else{
            Write-Host "Can't find file at $CSVPath"
            <# write log#>
            $lineNum = Get-CurrentLineNumber    
            $filName = Get-CurrentFileName 
            WriteToLogFile -LNumber $lineNum -FName $filName -ActionError "Can't find file at $CSVPath"
        }
    }#end if Credentials
}#End Process

}

function Get-CurrentLineNumber {
    $MyInvocation.ScriptLineNumber
}

function Get-CurrentFileName{
    $MyInvocation.ScriptName.Substring($MyInvocation.ScriptName.LastIndexOf("\")+1)
}

function Get-CurrentFunctionName {
    (Get-Variable MyInvocation -Scope 1).Value.MyCommand.Name;
}

Function WriteToLogFile() {
    param( 
      [Parameter(Mandatory=$true)]
      [string]$LNumber,
      [Parameter(Mandatory=$true)]
      [string]$FName,
      [Parameter(Mandatory=$true)]
      [string]$ActionError
    )
    try{
        $headerString = "Time".PadRight(30, ' ') + "Line Number".PadRight(15,' ') + "FileName".PadRight(60,' ') + "Action"
        $stringToWrite = $(Get-Date -Format G).PadRight(30, ' ') + $($LNumber).PadRight(15, ' ') + $($FName).PadRight(60,' ') + $ActionError

        #check if file exists, create if it doesn't
        $getCurrentDatePath = "C:\Windows\Temp\" + (Get-Date -Format u).Substring(0,10)+"OfficeAutoScriptLog.txt"
        if(Test-Path $getCurrentDatePath){#if exists, append
             Add-Content $getCurrentDatePath $stringToWrite
        }
        else{#if not exists, create new
             Add-Content $getCurrentDatePath $headerString
             Add-Content $getCurrentDatePath $stringToWrite
        }
    } catch [Exception]{
        Write-Host $_
    }
}